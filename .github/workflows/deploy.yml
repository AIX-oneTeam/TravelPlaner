name: CI/CD to AWS ECR AND EC2

on:
  push:
    branches:
      - dev
      - docs/hj-git-action-#23
  workflow_dispatch:

jobs:
  build:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    steps:
      # GitHub Actions ë³€ìˆ˜ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë“±ë¡
      - name: Set up environment variables
        run: |
          echo "í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤..."
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV

          # í˜„ì¬ stepì—ì„œ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ export
          export AWS_REGION="${{ secrets.AWS_REGION }}"
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"

          # í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹…
          echo "AWS_REGION=$AWS_REGION"
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID"
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY"
      # ì²´í¬ì•„ì›ƒ / ë¦¬í¬ì§€ ìƒìœ„ ë””ë ‰í† ë¦¬ë¡œ ìë™ ì´ë™
      - name: Checkout code
        uses: actions/checkout@v3

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.ECR_REPOSITORY_URI }}/backend:latest .

      # Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push Docker image to ECR
        run: |
          docker push ${{ secrets.ECR_REPOSITORY_URI }}/backend:latest

        # EC2ë¡œ ë°°í¬
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: SSH to EC2
        uses: appleboy/ssh-action@v0.1.7 # sshë¥¼ ì´ìš©í•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          # appleboy ì›ê²© ì‰˜ì— github runnerí™˜ê²½ì˜ í™˜ê²½ë³€ìˆ˜ ì „ë‹¬
          envs: AWS_REGION, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
          script: |
            set -e  # ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨

            # í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹…
            echo "AWS_REGION=$AWS_REGION"
            echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID"
            echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY"
            echo "Amazon ECRì— ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤..."

            aws ecr get-login-password --region $AWS_REGION \
             | docker login --username AWS --password-stdin ${{ secrets.ECR_REPOSITORY_URI }}
            echo "'backend' ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤..."
            if docker ps -a --filter "name=backend" --format '{{.Names}}' | grep -w backend; then
             echo "'backend' ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ì§€ ë° ì œê±°í•©ë‹ˆë‹¤..."
             docker stop backend
             docker rm backend
            else
             echo "'backend' ì»¨í…Œì´ë„ˆê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¤‘ì§€ ë° ì œê±° ë‹¨ê³„ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            fi

            echo "Amazon ECRì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤..."
            docker pull ${{ secrets.ECR_REPOSITORY_URI }}/backend:latest
            echo "ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
            docker run -d --name backend -p 8000:8000 ${{ secrets.ECR_REPOSITORY_URI }}/backend:latest
            echo "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."

  discord_alarm:
    name: Discord Alarm
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord message
        uses: tsickert/discord-webhook@v5.3.0
        with:
          url: ${{ secrets.DISCORD_WEB_HOOK_URL }}
          message: "ğŸ˜Š ë°±ì—”ë“œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
